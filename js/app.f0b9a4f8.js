(function(e){function t(t){for(var n,a,o=t[0],i=t[1],c=t[2],d=0,p=[];d<o.length;d++)a=o[d],Object.prototype.hasOwnProperty.call(s,a)&&s[a]&&p.push(s[a][0]),s[a]=0;for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n]);f&&f(t);while(p.length)p.shift()();return u.push.apply(u,c||[]),r()}function r(){for(var e,t=0;t<u.length;t++){for(var r=u[t],n=!0,a=1;a<r.length;a++){var o=r[a];0!==s[o]&&(n=!1)}n&&(u.splice(t--,1),e=i(i.s=r[0]))}return e}var n={},a={app:0},s={app:0},u=[];function o(e){return i.p+"js/"+({}[e]||e)+"."+{"chunk-bf4af3e6":"c90f81b4"}[e]+".js"}function i(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.e=function(e){var t=[],r={"chunk-bf4af3e6":1};a[e]?t.push(a[e]):0!==a[e]&&r[e]&&t.push(a[e]=new Promise((function(t,r){for(var n="css/"+({}[e]||e)+"."+{"chunk-bf4af3e6":"4b66110e"}[e]+".css",s=i.p+n,u=document.getElementsByTagName("link"),o=0;o<u.length;o++){var c=u[o],d=c.getAttribute("data-href")||c.getAttribute("href");if("stylesheet"===c.rel&&(d===n||d===s))return t()}var p=document.getElementsByTagName("style");for(o=0;o<p.length;o++){c=p[o],d=c.getAttribute("data-href");if(d===n||d===s)return t()}var f=document.createElement("link");f.rel="stylesheet",f.type="text/css",f.onload=t,f.onerror=function(t){var n=t&&t.target&&t.target.src||s,u=new Error("Loading CSS chunk "+e+" failed.\n("+n+")");u.code="CSS_CHUNK_LOAD_FAILED",u.request=n,delete a[e],f.parentNode.removeChild(f),r(u)},f.href=s;var g=document.getElementsByTagName("head")[0];g.appendChild(f)})).then((function(){a[e]=0})));var n=s[e];if(0!==n)if(n)t.push(n[2]);else{var u=new Promise((function(t,r){n=s[e]=[t,r]}));t.push(n[2]=u);var c,d=document.createElement("script");d.charset="utf-8",d.timeout=120,i.nc&&d.setAttribute("nonce",i.nc),d.src=o(e);var p=new Error;c=function(t){d.onerror=d.onload=null,clearTimeout(f);var r=s[e];if(0!==r){if(r){var n=t&&("load"===t.type?"missing":t.type),a=t&&t.target&&t.target.src;p.message="Loading chunk "+e+" failed.\n("+n+": "+a+")",p.name="ChunkLoadError",p.type=n,p.request=a,r[1](p)}s[e]=void 0}};var f=setTimeout((function(){c({type:"timeout",target:d})}),12e4);d.onerror=d.onload=c,document.head.appendChild(d)}return Promise.all(t)},i.m=e,i.c=n,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw e};var c=window["webpackJsonp"]=window["webpackJsonp"]||[],d=c.push.bind(c);c.push=t,c=c.slice();for(var p=0;p<c.length;p++)t(c[p]);var f=d;u.push([0,"chunk-vendors"]),r()})({0:function(e,t,r){e.exports=r("cd49")},"0613":function(e,t,r){"use strict";var n,a,s=r("8bbf"),u=r.n(s),o=r("5880"),i=r.n(o),c=(r("96cf"),r("1da1")),d="set_user",p="clear_user",f="set_token",g="set_mobile",m="set_background",h=r("48b8"),b=r("d54a").default,l=(r("3f4c").default,{register:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n,a,s;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,r.next=4,b.register(t);case 4:if(a=r.sent,s=Object(h["g"])(a),!s){r.next=10;break}return n(d,s.user),n(f,s.token),r.abrupt("return",s);case 10:case"end":return r.stop()}}),r)})))()},login:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n,a,s;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,r.next=3,b.login(t);case 3:if(a=r.sent,s=Object(h["g"])(a),!s){r.next=10;break}return n(d,s.user),n(f,s.token),r.abrupt("return",s);case 10:case"end":return r.stop()}}),r)})))()}}),v=l,I=r("ade3"),y=r("a78e"),w=r.n(y),O=(n={},Object(I["a"])(n,d,(function(e,t){e.user=t,localStorage.setItem("user",JSON.stringify(t)),w.a.set("user",t,{expires:3650})})),Object(I["a"])(n,p,(function(e){e.user={userId:"",username:"",password:"",avatar:"",createTime:0,publicId:""},localStorage.setItem("user",""),w.a.set("user","")})),Object(I["a"])(n,f,(function(e,t){e.token=t,w.a.set("token",t,{expires:3})})),Object(I["a"])(n,g,(function(e,t){e.mobile=t})),Object(I["a"])(n,m,(function(e,t){e.background=t,localStorage.setItem("background",t)})),n),R=O,j={user:function(e){e.user;var t=w.a.get("user");return t=localStorage.getItem("user"),t?(e.user=JSON.parse(t),e.user):{}},mobile:function(e){return e.mobile},background:function(e){return e.background,localStorage.getItem("background")}},x=j,k={user:{userId:"",username:"",password:"",avatar:"",createTime:0,publicId:""},token:"",mobile:!1,background:""},G=k,S={namespaced:!0,state:G,mutations:R,actions:v,getters:x},U=S,_=(r("99af"),r("b85c")),M=r("8055"),A=r.n(M),N="set_socket",$="set_dropped",T="set_active_group_user",P="set_active_room",E="set_user_gather",D="set_friend_gather",z="set_group_gather",F="add_group_message",B="set_group_messages",K="add_friend_message",q="set_friend_messages",C="del_group",J="del_friend",H="set_unread_gather",L="lose_unread_gather",V=r("3fff"),W=r("cfbb"),Q=r("21e1"),Z=r("5ab6"),X=r("302f"),Y=r("a090").default,ee=(r("3f4c").default,{addGroup:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=e.commit,e.state,e.dispatch,e.rootState,!t.code){r.next=4;break}return r.abrupt("return",u.a.prototype.$message.error(t.msg));case 4:u.a.prototype.$message.success(t.msg),n(z,t.data);case 6:case"end":return r.stop()}}),r)})))()},joinGroup:function(e,t){var r=e.commit,n=e.state,a=(e.dispatch,e.rootState),s=a.app.user;if(t.code)return u.a.prototype.$message.error(t.msg);var o=t.data.user,i=t.data.group;if(o.userId!=s.userId)return r(E,o),u.a.prototype.$message.info("".concat(o.username,"加入群").concat(i.groupName));n.groupGather[i.groupId]||(r(z,i),Q["a"].getChatData(s)),u.a.prototype.$message.info("成功加入群".concat(i.groupName)),r(P,n.groupGather[i.groupId])},joinGroupSocket:function(e,t){var r=e.commit,n=e.state,a=(e.dispatch,e.rootState),s=a.app.user;if(t.code)return u.a.prototype.$message.error(t.msg);var o=t.data.user,i=t.data.group,c=n.friendGather;if(o.userId!=s.userId){var d;if(r(E,o),c[o.userId])c[o.userId].messages&&(d=c[o.userId].messages),r(D,o),r(q,d);if(window.msg===o.userId)return;return window.msg=o.userId,u.a.prototype.$message.info("".concat(o.username,"加入群").concat(i.groupName))}n.groupGather[i.groupId]||r(z,i),r(E,o)},groupMessage:function(e,t){var r=e.commit,n=e.state;e.dispatch,e.rootState;if(t.code)u.a.prototype.$message.error(t.msg);else{r(F,t.data);var a=n.activeRoom;a&&a.groupId!==t.data.groupId&&r(H,t.data.groupId)}},serviceMessage:function(e,t){e.commit,e.state;var r=e.dispatch;e.rootState;r("groupMessage",{code:X["a"].OK,msg:"",data:{userId:"0",groupId:Z["a"].groupId,content:t,width:void 0,height:void 0,messageType:"text"}})},chatData:function(e,t){var r=e.commit,n=(e.state,e.dispatch);e.rootState;if(t.code)return u.a.prototype.$message.error(t.msg);n("handleChatData",t.data),r($,!1)},connectSocket:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function t(){var r,n,a,s,o,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:r=e.commit,n=e.state,a=e.dispatch,s=e.rootState,o=s.app.user,Y.getAllData(o),i=A.a.connect("/?userId=".concat(o.userId),{reconnection:!0}),i.on("connect",Object(c["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:i.emit("chatData",o),r(N,i);case 3:case"end":return e.stop()}}),e)})))),i.on("activeGroupUser",(function(e){r(T,e.data)})),i.on("addGroup",(function(e){if(e.code)return u.a.prototype.$message.error(e.msg);u.a.prototype.$message.success(e.msg),r(z,e.data)})),i.on("joinGroup",function(){var e=Object(c["a"])(regeneratorRuntime.mark((function e(t){var a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!t.code){e.next=3;break}return e.abrupt("return",u.a.prototype.$message.error(t.msg));case 3:if(a=t.data.user,s=t.data.group,a.userId==o.userId){e.next=10;break}return r(E,a),e.abrupt("return",u.a.prototype.$message.info("".concat(a.username,"加入群").concat(s.groupName)));case 10:n.groupGather[s.groupId]||(r(z,s),i.emit("chatData",o)),u.a.prototype.$message.info("成功加入群".concat(s.groupName)),r(P,n.groupGather[s.groupId]);case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),i.on("joinGroupSocket",(function(e){if(e.code)return u.a.prototype.$message.error(e.msg);var t=e.data.user,a=e.data.group,s=n.friendGather;if(t.userId!=o.userId){var i;if(r(E,t),s[t.userId])s[t.userId].messages&&(i=s[t.userId].messages),r(D,t),r(q,i);if(window.msg===t.userId)return;return window.msg=t.userId,u.a.prototype.$message.info("".concat(t.username,"加入群").concat(a.groupName))}n.groupGather[a.groupId]||r(z,a),r(E,t)})),i.on("groupMessage",(function(e){if(e.code)u.a.prototype.$message.error(e.msg);else{r(F,e.data);var t=n.activeRoom;t&&t.groupId!==e.data.groupId&&r(H,e.data.groupId)}})),i.on("addFriend",(function(e){e.code?u.a.prototype.$message.error(e.msg):(r(D,e.data),r(E,e.data),u.a.prototype.$message.info(e.msg),i.emit("joinFriendSocket",{userId:o.userId,friendId:e.data.userId}))})),i.on("joinFriendSocket",(function(e){e.code})),i.on("friendMessage",(function(e){if(e.code)u.a.prototype.$message.error(e.msg);else if(e.data.friendId===o.userId||e.data.userId===o.userId){r(K,e.data);var t=n.activeRoom;t&&t.userId!==e.data.userId&&t.userId!==e.data.friendId&&r(H,e.data.userId)}})),i.on("chatData",(function(e){if(e.code)return u.a.prototype.$message.error(e.msg);a("handleChatData",e.data),r($,!1)})),i.on("exitGroup",(function(e){e.code?u.a.prototype.$message.error(e.msg):(r(C,e.data),r(P,n.groupGather[V["b"]]),u.a.prototype.$message.success(e.msg))})),i.on("exitFriend",(function(e){e.code?u.a.prototype.$message.error(e.msg):(r(J,e.data),r(P,n.groupGather[V["b"]]),u.a.prototype.$message.success(e.msg))}));case 17:case"end":return t.stop()}}),t)})))()},handleChatData:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n,a,s,u,o,i,c,d,p,f,g,m,h,b,l,v,I,y,w,O,R;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=e.commit,e.dispatch,a=e.state,s=e.rootState,u=s.app.user,o=a.socket,i=a.groupGather,c=t.groupData,d=t.friendData,p=t.userData,c.length){f=Object(_["a"])(c);try{for(f.s();!(g=f.n()).done;)m=g.value,W["a"].joinGroupSocket({groupId:m.groupId,userId:u.userId}),n(z,m)}catch(j){f.e(j)}finally{f.f()}}if(d.length){h=Object(_["a"])(d);try{for(h.s();!(b=h.n()).done;)l=b.value,o.emit("joinFriendSocket",{userId:u.userId,friendId:l.userId}),n(D,l)}catch(j){h.e(j)}finally{h.f()}}if(p.length){v=Object(_["a"])(p);try{for(v.s();!(I=v.n()).done;)y=I.value,n(E,y)}catch(j){v.e(j)}finally{v.f()}}if(w=a.activeRoom,O=a.groupGather,R=a.friendGather,w){r.next=15;break}return r.abrupt("return",n(P,i[V["b"]]));case 15:n(P,O[w.groupId]||R[w.userId]);case 16:case"end":return r.stop()}}),r)})))()}}),te=ee,re=(r("07ac"),a={},Object(I["a"])(a,N,(function(e,t){e.socket=t})),Object(I["a"])(a,$,(function(e,t){e.dropped=t})),Object(I["a"])(a,T,(function(e,t){e.activeGroupUser=t;for(var r=e.userGather,n=0,a=Object.values(t[V["b"]]);n<a.length;n++){var s=a[n];u.a.set(r,s.userId,s)}})),Object(I["a"])(a,F,(function(e,t){e.groupGather[t.groupId].messages?e.groupGather[t.groupId].messages.push(t):u.a.set(e.groupGather[t.groupId],"messages",[t])})),Object(I["a"])(a,B,(function(e,t){t&&t.length&&u.a.set(e.groupGather[t[0].groupId],"messages",t)})),Object(I["a"])(a,K,(function(e,t){var r=this.getters["app/user"].userId;t.friendId===r?e.friendGather[t.userId].messages?e.friendGather[t.userId].messages.push(t):u.a.set(e.friendGather[t.userId],"messages",[t]):e.friendGather[t.friendId].messages?e.friendGather[t.friendId].messages.push(t):u.a.set(e.friendGather[t.friendId],"messages",[t])})),Object(I["a"])(a,q,(function(e,t){var r=this.getters["app/user"].userId;t&&t.length&&(t[0].friendId===r?u.a.set(e.friendGather[t[0].userId],"messages",t):u.a.set(e.friendGather[t[0].friendId],"messages",t))})),Object(I["a"])(a,P,(function(e,t){e.activeRoom=t})),Object(I["a"])(a,z,(function(e,t){u.a.set(e.groupGather,t.groupId,t)})),Object(I["a"])(a,E,(function(e,t){u.a.set(e.userGather,t.userId,t)})),Object(I["a"])(a,D,(function(e,t){u.a.set(e.friendGather,t.userId,t)})),Object(I["a"])(a,C,(function(e,t){u.a.delete(e.groupGather,t.groupId)})),Object(I["a"])(a,J,(function(e,t){u.a.delete(e.friendGather,t.friendId)})),Object(I["a"])(a,H,(function(e,t){e.unReadGather[t]?++e.unReadGather[t]:u.a.set(e.unReadGather,t,1)})),Object(I["a"])(a,L,(function(e,t){u.a.set(e.unReadGather,t,0)})),a),ne=re,ae={socket:function(e){return e.socket},dropped:function(e){return e.dropped},activeGroupUser:function(e){return e.activeGroupUser},activeRoom:function(e){return e.activeRoom},groupGather:function(e){return e.groupGather},friendGather:function(e){return e.friendGather},userGather:function(e){return e.userGather},unReadGather:function(e){return e.unReadGather}},se=ae,ue={socket:null,dropped:!1,activeGroupUser:{},activeRoom:null,groupGather:{},userGather:{},friendGather:{},unReadGather:{}},oe=ue,ie={namespaced:!0,state:oe,mutations:ne,actions:te,getters:se},ce=ie;u.a.use(i.a);var de={app:U,chat:ce};t["a"]=new i.a.Store({modules:de})},1:function(e,t){},10:function(e,t){},11:function(e,t){},12:function(e,t){},13:function(e,t){},14:function(e,t){},15:function(e,t){},"15a6":function(e,t,r){"use strict";r("4dec");t["a"]={roomObjects:{},user:{username:"",userId:""},groupMessageRepository:{},db:{},hasInit:!1,web3:{},interval:{},iterations:0}},16:function(e,t){},17:function(e,t){},18:function(e,t){},19:function(e,t){},2:function(e,t){},20:function(e,t){},21:function(e,t){},"21e1":function(e,t,r){"use strict";r("3f4c");var n=r("a090"),a=r("0613");r("302f");t["a"]={refreshChatData:function(e){a["a"].dispatch("chat/chatData",e)},getChatData:function(e){n["default"].getAllData(e)}}},22:function(e,t){},23:function(e,t){},24:function(e,t){},3:function(e,t){},"302f":function(e,t,r){"use strict";var n;r.d(t,"a",(function(){return n})),function(e){e[e["OK"]=0]="OK",e[e["FAIL"]=1]="FAIL",e[e["ERROR"]=2]="ERROR"}(n||(n={}))},"3f4c":function(e,t,r){"use strict";r.r(t);r("99af"),r("7db0"),r("07ac"),r("ac1f"),r("1276");var n=r("3835"),a=r("b85c"),s=(r("96cf"),r("1da1")),u=(r("99e5"),r("cfbb")),o=r("a090"),i=r("15a6"),c=r("4dec"),d=(r("0613"),r("302f")),p=(r("5ab6"),r("739d")),f=(r("a002"),function(e,t){var r=e.query.userName;GROUP_USER.findGroupByUserName(r).then((function(e){return t.json({status:2e3,data:e,msg:"获取群聊成功"})})).catch((function(e){return t.json({status:2003,data:e,msg:"服务端错误，请稍后重试！"})}))}),g=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.userId,s=n.groupIds,e.next=4,GROUP_USER.find({groupId:{$in:s},userId:a}).populate("groupId");case 4:return u=e.sent,e.abrupt("return",r.json({status:2e3,data:u,msg:"获取成功！"}));case 7:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),m=function(e,t){var r=e.query.id;GROUP.find({_id:r}).then((function(e){if(!e.length)return t.json({status:2001,data:"",msg:"未获取到群聊信息"});GROUP_USER.findGroupUsersByGroupId(r).then((function(r){return t.json({status:2e3,data:{group:e,users:r},msg:"获取群聊详情成功"})}))})).catch((function(e){return t.json({status:2003,data:e,msg:"服务端错误，请稍后重试！"})}))},h=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,u,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:n=t.query,a=n.type,s=n.q,u=n.page,o=n.pageSize,GROUP.searchGroup(a,s,u,o).then((function(e){return r.json({status:2e3,data:e,msg:"success"})})).catch((function(e){return r.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}));case 2:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),b=function(e){var t=e.userId,r=e.groupId,n=e.userName;GROUP_USER.findOne({userId:t,groupId:r}).then((function(t){t||GROUP_USER.insertMany(e).then((function(e){GROUP.update({_id:r},{$inc:{userNum:1}});var t={roomid:r,message:"".concat(n,"加入群聊"),messageType:"sys",isReadUser:[]};insertNewGroupNews(t)}))})).catch((function(e){return res.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}))},l=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,u,o,i,c,d,p,f,g,m;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ACCOUNTBASE.findOne({status:"0",type:"2"});case 3:return n=e.sent,e.next=6,ACCOUNTBASE.findOneAndUpdate({code:n.code},{status:"1"});case 6:return a=t.body,s=a.title,u=a.desc,o=void 0===u?"":u,i=a.holderName,c=a.holderUserId,d=t.body.img||"/img/zwsj5.png",p={title:s,desc:o,img:d,code:n.code,holderName:i,holderUserId:c},e.next=12,GROUP.insertMany(p);case 12:return f=e.sent,g={groupId:f[0]._id,userId:c,userName:i,manager:0,holder:1,card:""},e.next=16,GROUP_USER.insertMany(g);case 16:return m=e.sent,e.abrupt("return",r.json({status:2e3,data:{groupData:f,groupUserData:m}}));case 20:return e.prev=20,e.t0=e["catch"](0),e.abrupt("return",r.json({status:2003,data:e.t0,msg:"服务器错误，请稍后重试！"}));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(t,r){return e.apply(this,arguments)}}(),v=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,GROUP.find().populate({path:"holderUserId",select:"nickname photo signature"});case 2:return n=e.sent,e.abrupt("return",r.json({status:2e3,data:n,msg:"获取成功！"}));case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),I=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,i["a"].db.groupRepository.where({groupId:t.groupId}).first();case 3:return r=e.sent,e.next=6,i["a"].db.userRepository.where({userId:t.userId}).first();case 6:n=e.sent,x(t.groupId),a={group:r,user:n},u["a"].clientJoinGroupSocket({code:d["a"].OK,msg:"".concat(n.username,"加入群").concat(r.groupName),data:a});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.groupName=t.groupId.split(":")[0],t.groupId=t.groupId.split(":")[1],r={groupId:t.groupId,groupName:t.groupName},e.next=8,i["a"].db.groupUserRepository.where({groupId:r.groupId,userId:t.userId}).first();case 8:if(n=e.sent,a=i["a"].user,!r||!a){e.next=29;break}if(n){e.next=24;break}return t.groupId=r.groupId,e.next=18,i["a"].db.groupUserRepository.toArray();case 18:return e.sent,e.next=22,i["a"].db.groupUserRepository.add({groupId:t.groupId,userId:t.userId});case 22:n=e.sent;case 24:s={group:r,user:a},u["a"].clientJoinGroup({code:d["a"].OK,msg:"".concat(a.username,"加入群").concat(r.groupName),data:s}),e.next=30;break;case 29:u["a"].clientJoinGroup({code:d["a"].FAIL,msg:"进群失败",data:""});case 30:e.next=33;break;case 32:u["a"].clientJoinGroup({code:d["a"].FAIL,msg:"你没资格进群"});case 33:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),w=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){var a,s,d,p,f,g;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r.userId==i["a"].user.userId){e.next=47;break}e.prev=3,a=i["a"].web3.eth.accounts.recover(r.hash,r.signature),e.next=11;break;case 7:return e.prev=7,e.t0=e["catch"](3),e.abrupt("return");case 11:if(a==r.userId){e.next=14;break}return e.abrupt("return");case 14:if(r.groupId==t){e.next=17;break}return e.abrupt("return");case 17:if(r.hash==i["a"].web3.eth.accounts.hashMessage(r.preHash+r.groupId+r.content+r.time)){e.next=19;break}return e.abrupt("return");case 19:if(!(r.time>Date.now())){e.next=22;break}return e.abrupt("return");case 22:if("text"!=r.messageType){e.next=35;break}return e.next=26,i["a"].db.groupMessageRepository.where("[groupId+time]").between([t,c["a"].minKey],[t,c["a"].maxKey]).reverse().first();case 26:if(s=e.sent,r.time>s.time?i["a"].db.groupMessageRepository.add(r).then((function(){u["a"].receiveGroupMessage(t,r.content,n)})).catch((function(e){})):i["a"].db.groupMessageRepository.add(r).then((function(){return o["default"].getAllData(i["a"].user)})).catch((function(e){})),r.preHash==r.groupId){e.next=34;break}return e.next=32,i["a"].db.groupMessageRepository.where({hash:r.preHash}).first();case 32:d=e.sent,d||R({userId:i["a"].user.userId,groupId:t,content:{key:"hash",hash:r.preHash},messageType:"requireOldMessage"});case 34:return e.abrupt("return");case 35:if("requireOldMessage"!=r.messageType){e.next=47;break}if("hash"!=r.content.key){e.next=41;break}return e.next=39,i["a"].db.groupMessageRepository.where({hash:r.content.hash}).first();case 39:p=e.sent,i["a"].roomObjects[r.groupId].sendMessage(p,i["a"].roomObjects[t].userIdsToIds[r.userId]);case 41:if("time"!=r.content.key){e.next=47;break}return e.next=44,i["a"].db.groupMessageRepository.where("time").between(r.content.time[0],r.content.time[1]).toArray();case 44:for(g in f=e.sent,f)i["a"].roomObjects[r.groupId].sendMessage(f[g],i["a"].roomObjects[t].userIdsToIds[r.userId]);case 47:case"end":return e.stop()}}),e,null,[[3,7]])})));return function(t,r,n){return e.apply(this,arguments)}}(),O=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){var s,u,o,d,p,f;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,i["a"].db.groupMessageRepository.where("[groupId+time]").between([t,c["a"].minKey],[t,c["a"].maxKey]).reverse().offset(r).limit(n).toArray();case 3:s=e.sent,s=s.reverse(),u={},o=[],d=Object(a["a"])(s),e.prev=8,d.s();case 10:if((p=d.n()).done){e.next=19;break}if(f=p.value,u[f.userId]){e.next=17;break}return e.next=16,i["a"].db.userRepository.where({userId:f.userId}).first();case 16:u[f.userId]=e.sent;case 17:e.next=10;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e["catch"](8),d.e(e.t0);case 24:return e.prev=24,d.f(),e.finish(24);case 27:return o=Object.values(u),e.abrupt("return",{msg:"",data:{messageArr:s,userArr:o}});case 29:case"end":return e.stop()}}),e,null,[[8,21,24,27]])})));return function(t,r,n){return e.apply(this,arguments)}}(),R=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return"image"===t.messageType&&(r="".concat(Date.now(),"$").concat(t.userId,"$").concat(t.width,"$").concat(t.height),n=createWriteStream(join("public/static",r)),n.write(t.content),t.content=r),t.time=Date.now(),e.next=5,i["a"].db.groupRepository.where({groupId:t.groupId}).first();case 5:if(a=e.sent,t.preHash=a.lastMessage,t.hash=i["a"].web3.eth.accounts.hashMessage(a.lastMessage+t.groupId+t.content+t.time),s=i["a"].web3.eth.accounts.sign(t.hash,i["a"].user.privateKey),t.signature=s.signature,"text"!==t.messageType){e.next=18;break}return i["a"].db.groupMessageRepository.add(t),e.next=15,i["a"].db.groupRepository.update(t.groupId,{lastMessage:t.hash});case 15:i["a"].roomObjects[t.groupId].sendMessage(t),u["a"].receiveGroupMessage(t.groupId,t.content,i["a"].user.userId);case 18:"requireOldMessage"==t.messageType&&i["a"].roomObjects[t.groupId].sendMessage(t);case 19:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),j=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),x=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,a,s,u,o,d,f,g,m,h,b,l,v,I,y,O,R,x,G,S,U,_,M,A;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:r={appId:"ichat"},a=Object(p["a"])(r,t),a.onPeerJoin((function(e){})),s=a.makeAction("message"),u=Object(n["a"])(s,2),o=u[0],d=u[1],d((function(e,r){w(t,e,i["a"].roomObjects[t].idsToUserIds[r])})),f=a.makeAction("private"),g=Object(n["a"])(f,2),m=g[0],h=g[1],h((function(e,r){w(t,e,i["a"].roomObjects[t].idsToUserIds[r])})),b=a.makeAction("requireOld"),l=Object(n["a"])(b,2),v=l[0],I=l[1],I((function(e,r){R(t,e,i["a"].roomObjects[t].idsToUserIds[r])})),y=a.makeAction("oldMessage"),O=Object(n["a"])(y,2),R=O[0],x=O[1],x((function(e,r){j(t,e,t,i["a"].roomObjects[t].idsToUserIds[r])})),G={},S={},G[p["b"]]=i["a"].user.username,S[p["b"]]=i["a"].user.userId,i["a"].roomObjects[t]={object:a,sendMessage:o,sendPrivateMessage:m,sendOldMessage:R,requireOldMessage:v,idsToNames:G,idsToUserIds:S,userIdsToIds:{},offline:[],groupId:t},U=a.makeAction("name"),_=Object(n["a"])(U,2),M=_[0],A=_[1],M(i["a"].user.username+":"+i["a"].user.userId),A((function(e,r){i["a"].roomObjects[t].idsToNames[r]=e.split(":")[0];var n=e.split(":")[1];i["a"].roomObjects[t].idsToUserIds[r]=n,i["a"].roomObjects[t].userIdsToIds[n]=r,i["a"].db.userRepository.add({userId:n,username:e.split(":")[0]})})),i["a"].db.groupMessageRepository.where("[groupId+time]").between([t,c["a"].minKey],[t,c["a"].maxKey]).reverse().first().then((function(e){i["a"].roomObjects[t].offline=[e.time,Date.now()],i["a"].iterations})).catch((function(e){})),a.onPeerJoin((function(e){M(i["a"].user.username+":"+i["a"].user.userId,e),0==i["a"].iterations&&setTimeout(k,10)}));case 23:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),k=function(){for(var e in i["a"].iterations++,i["a"].roomObjects){var t=i["a"].roomObjects[e];t.offline&&R({userId:i["a"].user.userId,groupId:t.groupId,content:{key:"time",time:t.offline},messageType:"requireOldMessage"})}i["a"].iterations>2&&(clearInterval(i["a"].interval),i["a"].iterations=0)};t["default"]={getMyGroup:f,getGroupInfo:m,searchGroup:h,addNewGroupUser:b,createGroup:l,getRecentGroup:g,getAllGroup:v,joinGroup:y,joinGroupSocket:I,roomInit:x,receiveGroupMessage:w,sendGroupMessage:R,getGroupMessages:O}},"3fff":function(e,t,r){"use strict";r.d(t,"b",(function(){return n})),r.d(t,"a",(function(){return a}));var n="阿童木聊天室",a="https://images.weserv.nl/?url=https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/453b8ebcdefa46a69c620da13f346ce2~tplv-k3u1fbpfcp-zoom-1.image?imageView2/2/w/800/q/85"},4:function(e,t){},"48b8":function(e,t,r){"use strict";r.d(t,"g",(function(){return s})),r.d(t,"b",(function(){return u})),r.d(t,"e",(function(){return o})),r.d(t,"c",(function(){return i})),r.d(t,"a",(function(){return c})),r.d(t,"d",(function(){return d})),r.d(t,"f",(function(){return p}));r("c975"),r("4d63"),r("ac1f"),r("25f0");var n=r("8bbf"),a=r.n(n);r("99e5");function s(e){var t=e.code,r=e.msg,n=e.data;if(!t)return r&&a.a.prototype.$message.success(r),n;a.a.prototype.$message.error(r)}function u(e,t){return t.indexOf(e)>=0}function o(e){return e}function i(e){var t=new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/);return t.test(e)}function c(e){var t=a.a.prototype.$moment;return t().add(-1,"days").startOf("day")>e?t(e).format("M/D HH:mm"):t().startOf("day")>e?"昨天 "+t(e).format("HH:mm"):(new Date).valueOf()>e+3e5?t(e).format("HH:mm"):t(e).format("HH:mm:ss")}function d(e){var t=/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/;return 0===e.length?(a.a.prototype.$message.error("请输入名字"),!1):t.test(e)?!(e.length>9)||(a.a.prototype.$message.error("名字太长"),!1):(a.a.prototype.$message.error("名字只含有汉字、字母、数字和下划线 不能以下划线开头和结尾"),!1)}function p(e){var t=/^[0-9A-Z_a-z]+$/gi;return 0===e.length?(a.a.prototype.$message.error("请输入密码"),!1):t.test(e)?!(e.length>9)||(a.a.prototype.$message.error("密码太长"),!1):(a.a.prototype.$message.error("密码只含有字母、数字和下划线"),!1)}},5:function(e,t){},5880:function(e,t){e.exports=Vuex},"5ab6":function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return a}));var n={groupId:"o",groupName:"服务号"},a=["你好。欢迎使用去中心化聊天网页。本网页采用vuex，web3，webrtc等技术开发，所有数据保存在您的设备上，或加密保存在您好友的设备上。","添加好友：点击左上角的加号，点击搜索用户，输入好友分享给您的链接\n。\n\r个人设置：点击左上角头像。\n选择背景：点击左侧“衣服”符号。\n推出登陆：点击左下角“关机”符号。\n","技术细节：\n\r当您注册时，网页的js代码根据您输入的账号密码及当前时间，生成一个以太坊账号。该账号具有一个私钥。它是您的公开账号。\n添加好友：若A账号向B账号发送好友申请，它会"]},"5c0b":function(e,t,r){"use strict";var n=r("9c0c"),a=r.n(n);a.a},6:function(e,t){},6389:function(e,t){e.exports=VueRouter},7:function(e,t){},8:function(e,t){},"8bbf":function(e,t){e.exports=Vue},9:function(e,t){},"9c0c":function(e,t,r){},a090:function(e,t,r){"use strict";r.r(t),r.d(t,"getAllData",(function(){return m}));r("99af"),r("d81d"),r("d3b7"),r("07ac"),r("3ca3"),r("ddb0");var n=r("2909"),a=r("b85c"),s=(r("96cf"),r("1da1")),u=r("302f"),o=r("5ab6"),i=(r("0613"),r("739d"),r("a002"),r("3f4c"),r("e013"),r("21e1")),c=r("4dec"),d=r("15a6"),p=new c["a"](d["a"].user.userId);p.version(1).stores({groupUserRepository:"++_id, groupId, userId",groupMessageRepository:"++_id, userId, groupId, content, messageType, time",groupRepository:"groupId, userId, groupName, notice,createTime"});var f=r("99e5"),g=r.n(f),m=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,o,p,f,g,m,h,l,v,I,y,w,O,R,j;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return b(t.userId),r=d["a"].db,o=[],p=[],f={},g=[],e.next=9,r.groupUserRepository.where({userId:t.userId}).toArray();case 9:return m=e.sent,m.map((function(e){return e.groupId})),e.next=13,r.friendRepository.where({userId:t.userId}).toArray();case 13:return h=e.sent,l=m.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",r.groupRepository.where({groupId:t.groupId}).first());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),v=m.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var n,s,u,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=[],e.next=3,r.groupMessageRepository.orderBy("time");case 3:return e.next=6,r.groupMessageRepository.where("[groupId+time]").between([t.groupId,c["a"].minKey],[t.groupId,c["a"].maxKey]).reverse().limit(30).toArray();case 6:n=e.sent,n=n.reverse(),s=Object(a["a"])(n),e.prev=10,s.s();case 12:if((u=s.n()).done){e.next=20;break}if(o=u.value,f[o.userId]){e.next=18;break}return e.next=17,r.userRepository.where({userId:o.userId}).first();case 17:f[o.userId]=e.sent;case 18:e.next=12;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e["catch"](10),s.e(e.t0);case 25:return e.prev=25,s.f(),e.finish(25);case 28:return e.abrupt("return",n);case 29:case"end":return e.stop()}}),e,null,[[10,22,25,28]])})));return function(t){return e.apply(this,arguments)}}()),I=h.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,r.userRepository.where({userId:t.friendId}).first();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),y=h.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,friendMessageRepository.where("[userId+friendId+time]").between([t.userId,t.friendId,c["a"].minKey],[t.userId,t.friendId,c["a"].maxKey]).or("[userId+friendId+time]").between([t.friendId,t.userId,c["a"].minKey],[t.friendId,t.userId,c["a"].maxKey]).reverse().limit(30).sortBy("time").toArray();case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=20,Promise.all(l);case 20:return w=e.sent,e.next=23,Promise.all(v);case 23:return O=e.sent,w.map((function(e,t){O[t]&&O[t].length&&(e.messages=O[t])})),o=w,e.next=29,Promise.all(I);case 29:return R=e.sent,e.next=32,Promise.all(y);case 32:j=e.sent,R.map((function(e,t){j[t]&&j[t].length&&(e.messages=j[t])})),p=R,g=[].concat(Object(n["a"])(Object.values(f)),Object(n["a"])(p)),i["a"].refreshChatData({code:u["a"].OK,msg:"获取聊天数据成功",data:{groupData:o,friendData:p,userData:g}});case 37:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),h=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,d["a"].db.userRepository.add({userId:d["a"].user.userId,username:d["a"].user.username});case 2:return e.next=4,d["a"].db.groupRepository.add({groupId:o["a"].groupId,userId:t,groupName:"服务群",createTime:(new Date).valueOf(),lastMessage:o["a"].groupId});case 4:return e.next=6,d["a"].db.groupUserRepository.add({groupId:o["a"].groupId,userId:t});case 6:r=0;case 8:if(!(r<o["b"].length)){e.next=14;break}return e.next=11,d["a"].db.groupMessageRepository.add({userId:"0",groupId:o["a"].groupId,content:o["b"][r],width:void 0,height:void 0,messageType:"text",time:0});case 11:r++,e.next=8;break;case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),b=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=new c["a"](t),d["a"].db=r,r.version(1).stores({groupUserRepository:"++_id, groupId, userId",groupMessageRepository:"++_id, userId, groupId, content, messageType, time, preHash, hash, signature, [groupId+time]",groupRepository:"groupId, userId, groupName, createTime, lastMessage",friendRepository:"++_id, friendId, userId",userRepository:"userId, username",friendMessageRepository:"++_id, friendId, userId, content, time, [userId+friendId+time]"}),n=new g.a(new g.a.providers.WebsocketProvider("wss://rinkeby.infura.io/ws/v3/a898a2d231e647c7928dc457c6d441c8")),d["a"].web3=n,e.next=8,d["a"].db.userRepository.where({userId:d["a"].user.userId});case 8:a=e.sent,d["a"].user.avater=a.avater;case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),l=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();t["default"]={serviceInit:h,dbInit:b,dataInit:l,getAllData:m}},c32d:function(e,t){e.exports=moment},cd49:function(e,t,r){"use strict";r.r(t);r("e260"),r("e6cf"),r("cca6"),r("a79d");var n=r("8bbf"),a=r.n(n),s=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"app"}},[r("router-view"),e.background?r("img",{staticClass:"background",attrs:{src:e.background,alt:""}}):e._e()],1)},u=[],o=(r("ac1f"),r("466d"),r("498a"),r("d4ec")),i=r("bee2"),c=r("262e"),d=r("2caf"),p=r("9ab4"),f=r("60a3"),g=r("4bb5"),m=r("3fff"),h=Object(g["a"])("app"),b=function(e){Object(c["a"])(r,e);var t=Object(d["a"])(r);function r(){return Object(o["a"])(this,r),t.apply(this,arguments)}return Object(i["a"])(r,[{key:"mounted",value:function(){this.setMobile(this.isMobile()),this.background&&this.background.trim().length||this.set_background(m["a"])}},{key:"isMobile",value:function(){var e=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);return e&&e.length}}]),r}(f["c"]);Object(p["a"])([h.Getter("user")],b.prototype,"user",void 0),Object(p["a"])([h.Getter("background")],b.prototype,"background",void 0),Object(p["a"])([h.Mutation("set_mobile")],b.prototype,"setMobile",void 0),Object(p["a"])([h.Mutation("set_background")],b.prototype,"set_background",void 0),b=Object(p["a"])([f["a"]],b);var l=b,v=l,I=(r("5c0b"),r("2877")),y=Object(I["a"])(v,s,u,!1,null,null,null),w=y.exports,O=(r("d3b7"),r("6389")),R=r.n(O);a.a.use(R.a);var j=[{path:"/",name:"Chat",component:function(){return r.e("chunk-bf4af3e6").then(r.bind(null,"edc5"))}}],x=new R.a({mode:"history",base:"/",routes:j}),k=x,G=r("0613"),S=r("6944"),U=r.n(S),_=(r("3aed"),r("27fd")),M=r("5efb"),A=r("b558"),N=r("ed3b"),$=r("3af3"),T=r("bb76"),P=r("0c63"),E=r("ccb9"),D=r("681b"),z=r("a600"),F=r("55f1"),B=r("cdeb"),K=r("9839"),q=r("39ab"),C=r("f933"),J=r("9571"),H=r("768f"),L=r("a071"),V=r("f64c");a.a.use(_["a"]),a.a.use(M["a"]),a.a.use(A["a"]),a.a.use(N["a"]),a.a.use($["a"]),a.a.use(T["a"]),a.a.use(P["a"]),a.a.use(E["a"]),a.a.use(D["a"]),a.a.use(z["a"]),a.a.use(F["a"]),a.a.use(B["a"]),a.a.use(K["a"]),a.a.use(q["a"]),a.a.use(C["a"]),a.a.use(J["a"]),a.a.use(H["a"]),a.a.use(L["a"]),a.a.prototype.$message=V["a"];var W=r("c32d"),Q=r.n(W);r("0808");a.a.config.productionTip=!1,a.a.prototype.$moment=Q.a,a.a.use(U.a,{defaultOptions:{navbar:!1,title:!1,toolbar:{zoomIn:1,zoomOut:1,oneToOne:4,reset:4,prev:0,next:0,rotateLeft:4,rotateRight:4,flipHorizontal:4,flipVertical:4}}}),new a.a({router:k,store:G["a"],render:function(e){return e(w)}}).$mount("#app")},cebe:function(e,t){e.exports=axios},cfbb:function(e,t,r){"use strict";r("99af"),r("96cf");var n=r("1da1"),a=r("3f4c"),s=r("0613"),u=r("302f");t["a"]={getMyGroup:function(e){var t=e.userName;return request.get("".concat(API,"/group/getmygroup?userName=").concat(t))},getGroupInfo:function(e){var t=e.id;return request.get("".concat(API,"/group/groupinfo?id=").concat(t))},preFetchGroup:function(e){var t=e.type,r=e.q,n=e.page,a=e.pageSize;return request.get("".concat(API,"/group/prefetchgroup?type=").concat(t,"&q=").concat(r,"&page=").concat(n,"&pageSize=").concat(a))},createGroup:function(e){return request.post("".concat(API,"/group/create"),e)},getRecentGroupConversation:function(e){return request.post("".concat(API,"/group/recent"),e)},clientJoinGroup:function(e){s["a"].dispatch("chat/joinGroup",e)},serverJoinGroup:function(e){a["default"].joinGroup(e)},joinGroupSocket:function(e){a["default"].joinGroupSocket(e)},clientJoinGroupSocket:function(e){s["a"].dispatch("chat/joinGroupSocket",e)},getRecentGroupNews:function(e){var t=e.roomid,r=e.page,n=e.pageSize;return request.get("".concat(API,"/groupnews/recentnews?roomid=").concat(t,"&page=").concat(r,"&pageSize=").concat(n))},getGroupHistoryMsg:function(e){return request.post("".concat(API,"/groupnews/historymsg"),e)},getGroupLastNews:function(e){return request.post("".concat(API,"/groupnews/lastnews"),e)},receiveGroupMessage:function(e,t,r){s["a"].dispatch("chat/groupMessage",{code:u["a"].OK,msg:"",data:{userId:r,groupId:e,content:t,width:void 0,height:void 0,messageType:"text"}})},getGroupMessages:function(e){return Object(n["a"])(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,a["default"].getGroupMessages(e.groupId,e.current,e.pageSize);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)})))()},sendGroupMessage:function(e){a["default"].sendGroupMessage(e)}}},d54a:function(e,t,r){"use strict";r.r(t);r("7db0"),r("c740"),r("caad"),r("d81d"),r("a434"),r("b0c0"),r("a9e3"),r("b64b"),r("d3b7"),r("07ac"),r("4d63"),r("ac1f"),r("25f0"),r("2532");var n=r("ade3"),a=(r("96cf"),r("1da1")),s=r("302f"),u=r("5ab6"),o=r("15a6"),i=r("0613"),c=r("a090"),d=r("a002"),p=r.n(d),f=r("99e5"),g=r.n(f),m=(r("48b8"),function(e,t){var r=cvCode(),n=r.code,a=r.timestamp;return verificationCode=n,t.json({status:2e3,data:verificationCode,timestamp:a,msg:"code success"})}),h=function(){for(var e=0;e<u["b"].length;e++)i["a"].dispatch("chat/groupMessage",{code:s["a"].OK,msg:"",data:{userId:"0",groupId:u["a"].groupId,content:u["b"][e],width:void 0,height:void 0,messageType:"text"}})},b=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s,u,i,c,d,f;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=[t.username,t.password],n=r[0],a=r[1],Date.now(),u=JSON.parse(localStorage.getItem(n)),e.t0=JSON,e.next=6,p.a.getItem(n);case 6:e.t1=e.sent,u=e.t0.parse.call(e.t0,e.t1),c=new g.a(new g.a.providers.WebsocketProvider("wss://rinkeby.infura.io/ws/v3/a898a2d231e647c7928dc457c6d441c8")),e.prev=9,i=c.eth.accounts.decrypt(u.secPrivateKey,a),s=i.privateKey,e.next=18;break;case 14:return e.prev=14,e.t2=e["catch"](9),e.abrupt("return",{code:1,msg:"密码错误",data:""});case 18:return d={status:0,pass:a,name:i,_id:0},d._id,0,f=JSON.parse(localStorage.getItem(n)),o["a"].user={username:u.accountName,userId:u.accountAddress,password:a,avatar:f.avatar,role:"user",tag:"",privateKey:s},e.abrupt("return",{msg:"登录成功",data:{user:{username:u.accountName,userId:u.accountAddress,password:a,avatar:f.avatar,role:"user",tag:""},token:"0"}});case 27:case"end":return e.stop()}}),e,null,[[9,14]])})));return function(t){return e.apply(this,arguments)}}(),l=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,d,f,m,h,b,l,v,I,y;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=[t.username,t.password,t.password,t.cvCode,t.avatar],a=n[0],u=n[1],i=n[2],n[3],n[4],u===i){e.next=4;break}return e.abrupt("return",{code:s["a"].FAIL,msg:"注册校验不通过！",data:""});case 4:if(null==localStorage.getItem(a)){e.next=6;break}return e.abrupt("return",{code:s["a"].FAIL,msg:"用户已被注册,请换个用户名重试",data:""});case 6:return e.next=8,p.a.getItem(a);case 8:if(e.t0=e.sent,null==e.t0){e.next=11;break}return e.abrupt("return",{code:s["a"].FAIL,msg:"用户已被注册,请换个用户名重试",data:""});case 11:for(d=(new Date).getTime(),f=a+u+d,m=f.length;m<32;m++)f+="0";return h=new g.a(new g.a.providers.HttpProvider("http://localhost:8545")),b=h.eth.accounts.create([f]),f=h.eth.accounts.encrypt(b.privateKey,f),l=h.eth.accounts.create([f]),v=b.address,I=h.eth.accounts.encrypt(b.privateKey,u),y={accountName:a,accountAddress:v,secPrivateKey:I,contactList:{},role:"user",publicId:l.address,group:[{groupId:"0"}],avatar:""},o["a"].user={username:a,userId:v,password:u,privateKey:b.privateKey,avatar:"api/avatar/avatar(".concat(Math.round(19*Math.random()+1),").png"),role:"user",tag:""},localStorage.setItem(a,JSON.stringify(y)),e.next=26,p.a.setItem(a,JSON.stringify(y));case 26:return e.next=28,c["default"].dbInit(v);case 28:return e.next=30,c["default"].serviceInit(v);case 30:return e.abrupt("return",{msg:"注册成功",data:{user:{userId:v,username:a,password:u,avatar:"api/avatar/avatar(".concat(Math.round(19*Math.random()+1),").png"),role:"user",tag:"",createTime:d,publicId:l.address},token:"0"}});case 31:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),v=function(e){if(window.FileReader)var t=new FileReader;else alert("当前浏览器不支持!");return new Promise((function(r,n){try{e?(t.readAsDataURL(e),t.onload=function(){o["a"].db.userRepository.where({userId:o["a"].user.userId}).modify({avatar:this.result});var e=JSON.parse(localStorage.getItem(o["a"].user.username));e.avatar=this.result,localStorage.setItem(o["a"].user.username,JSON.stringify(e)),o["a"].user.avatar=this.result,r(o["a"].user)},t.onerror=function(){n("load file error")}):n("file not found")}catch(a){n("file not found")}}))},I=function(e,t){var r=e.query.id;USER.findById({_id:r}).then((function(e){return e?t.json({status:2e3,data:e,msg:"获取用户详情成功！"}):t.json({status:2001,data:"",msg:"没有获取到用户数据！"})})).catch((function(e){t.json({status:2003,data:"",msg:"服务端错误，请稍后重试！"})}))},y=function(e,t){var r=e.query,a=r.type,s=r.q,u=r.page,o=r.pageSize,i=new RegExp(s);USER.find(Object(n["a"])({},a,{$regex:i})).limit(Number(o)).skip(Number(u)*Number(o)).then((function(e){return t.json({status:2e3,data:e,msg:"获取成功！"})})).catch((function(e){return t.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}))},w=function(e,t){USER.find().then((function(e){return t.json({status:2e3,data:e,msg:"获取用户成功"})})).catch((function(e){return t.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}))},O=function(e,t){var r=e.query,n=r.gt,a=r.lt,s=new Date(n),u=new Date(a);USER.find({signUpTime:{$lte:u,$gte:s}}).sort({signUpTime:-1}).then((function(e){return t.json({status:2e3,data:e,msg:"成功"})}))},R=function(e,t){var r=e.body,n=r.id,a=r.state;USER.findByIdAndUpdate({_id:n},{status:a}).then((function(e){t.json({status:2e3,data:e,msg:"success"})})).catch((function(e){return t.json({status:2003,dataL:e,msg:"服务器错误，请稍后重试！"})}))},j=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var a,s,u,o,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=t.body,s=a.name,u=a.userId,e.next=3,USER.findOne({_id:u});case 3:return o=e.sent,i=o.friendFenzu,c=Object.keys(i),d=null,d=c.includes(s)?i:Object.assign({},i,Object(n["a"])({},s,[])),e.next=10,USER.findByIdAndUpdate({_id:u},{$set:{friendFenzu:d}});case 10:return p=e.sent,e.abrupt("return",r.json({status:2e3,data:p,msg:"添加新分组成功"}));case 12:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),x=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,u,o,i,c;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.fenzuName,s=n.userId,e.next=3,USER.findOne({_id:s});case 3:return u=e.sent,o=u.friendFenzu,i=JSON.parse(JSON.stringify(o)),delete i[a],e.next=9,USER.findByIdAndUpdate({_id:s},{$set:{friendFenzu:i}});case 9:return c=e.sent,e.abrupt("return",r.json({status:2e3,data:c,msg:"删除成功！"}));case 11:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),k=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,u,o,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.oldFenzu,s=n.newFenzu,u=n.userId,e.next=3,USER.findOne({_id:u});case 3:return o=e.sent,i=o.friendFenzu,c=JSON.parse(JSON.stringify(i)),d=i[a],delete c[a],c[s]=d,e.next=11,USER.findByIdAndUpdate({_id:u},{$set:{friendFenzu:c}});case 11:return p=e.sent,e.abrupt("return",r.json({status:2e3,data:p,msg:"更新成功！"}));case 13:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),G=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,u,o,i,c,d,p,f,g;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.userId,s=n.friendId,u=n.newFenzu,e.next=3,USER.findOne({_id:a});case 3:for(d in o=e.sent,i=JSON.parse(JSON.stringify(o.friendFenzu)),c="",i)i.hasOwnProperty(d)&&(p=i[d],p.includes(s)&&(c=d));if(c!==u){e.next=9;break}return e.abrupt("return",r.json({status:2e3,data:"",msg:"已经在次分组"}));case 9:return c&&(f=i[c].findIndex((function(e){return e===s})),i[c].splice(f,1)),i[u].push(s),e.next=14,USER.findByIdAndUpdate({_id:a},{$set:{friendFenzu:i}});case 14:return g=e.sent,e.abrupt("return",r.json({status:2e3,data:g,msg:"跟新成功"}));case 16:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),S=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var a,s,u,o,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=t.body,s=a.userId,u=a.friendId,o=a.friendBeizhu,e.next=3,USER.findOne({_id:s});case 3:return i=e.sent,c=i.friendBeizhu,d=Object.assign({},c,Object(n["a"])({},u,o)),e.next=8,USER.findByIdAndUpdate({_id:s},{$set:{friendBeizhu:d}});case 8:return p=e.sent,e.abrupt("return",r.json({status:2e3,data:p,msg:"修改备注成功！"}));case 10:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),U=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=t.userId,n=t.time,e.next=4,USER.findByIdAndUpdate({_id:r},{$inc:{onlineTime:Number(n)}});case 4:return a=e.sent,e.abrupt("return",a);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),_=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var a,s,u,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,a=t.body,s=a.field,u=a.value,o=a.userId,parseToken(t.headers.authorization)===o){e.next=4;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"错误操作！"}));case 4:return e.next=6,USER.findByIdAndUpdate({_id:o},Object(n["a"])({},s,u));case 6:return e.sent,e.abrupt("return",r.json({status:2e3,data:[],msg:"修改成功！"}));case 10:return e.prev=10,e.t0=e["catch"](0),e.abrupt("return",r.json({status:2003,data:e.t0,msg:"服务端错误！"}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,r){return e.apply(this,arguments)}}(),M=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,u,o,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,n=t.body,a=n.oldPwd,s=n.newPwd,u=n.reNewPwd,o=n.userId,e.next=4,USER.findOne({_id:o},{pass:1});case 4:if(i=e.sent,c=i.pass,d=md5(a),p=md5(s),parseToken(t.headers.authorization)===o){e.next=10;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"错误操作！"}));case 10:if(c===d){e.next=12;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"原始密码输入错误！"}));case 12:if(s===u){e.next=14;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"两次密码不一致！"}));case 14:return e.next=16,USER.findByIdAndUpdate({_id:o},{pass:p});case 16:return e.sent,e.abrupt("return",r.json({status:2e3,data:[],msg:"更新成功，请牢记你的新密码！"}));case 20:return e.prev=20,e.t0=e["catch"](0),e.abrupt("return",r.json({status:2003,data:[],msg:"服务端错误！"}));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(t,r){return e.apply(this,arguments)}}();t["default"]={login:b,serviceInit:h,generatorCode:m,register:l,getUserInfo:I,preFetchUser:y,getAllUser:w,getUserBySignUpTime:O,changeUserStatus:R,addNewFenzu:j,deleteFenzu:x,editFenzu:k,modifyFrienFenzu:G,modifyBeizhu:S,updateUserOnlineTime:U,updateUserInfo:_,updateUserPwd:M,setUserAvatar:v}}});